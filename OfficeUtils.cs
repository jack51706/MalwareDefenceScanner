using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Office.Interop.Word; // reference to "Microsoft Word Object Library"
using Microsoft.Office.Interop.Excel; // reference to "Microsoft Excel Object Library"
using Microsoft.Office.Core; // reference to "Microsoft Office Object Library"
using System.IO;

namespace MalwareDefenceScanner
{
    class OfficeUtils
    {
        // return true if MS Office file contains macros
        public static bool containsMacro(string filePath)
        {
            if (filePath.ToLower().EndsWith(".doc") || filePath.ToLower().EndsWith(".docm"))
            {
                return docContainsMacro(filePath);
            }
            else if ( filePath.ToLower().EndsWith(".xls") || filePath.ToLower().EndsWith(".xlsm") ||
               filePath.ToLower().EndsWith(".xlsb") || filePath.ToLower().EndsWith(".xlsx"))
            {
                return xlsContainsMacro(filePath);
            }
            else if(filePath.ToLower().EndsWith(".csv"))
            {
                return csvContainsMacro(filePath);
            }
            else
                return false;

        }

        static bool docContainsMacro(string filePath)
        {
            try
            {
                // Create MS Word instance
                Microsoft.Office.Interop.Word.Application w = new Microsoft.Office.Interop.Word.Application();
                // Disables macros 
                w.Application.AutomationSecurity = MsoAutomationSecurity.msoAutomationSecurityForceDisable;
              
                // Open document
                Microsoft.Office.Interop.Word.Document doc = w.Documents.Open(filePath, false, true);

                // Check if there are any macros
                if (doc.HasVBProject)
                {
                    return true;
                }

                // Close the document
                doc.Close();

                // Quit MS Word
                w.Quit();
            }
            catch (Exception ex)
            {
                throw ex;
            }

            return false;
        }


        // check if there are any Excel4 macro calls in a CSV file
        static bool csvContainsMacro(string filePath)
        {
            try
            {
                string f = File.ReadAllText(filePath);

                if (f.Contains("FORMULA(") || f.Contains("CALL(") || f.Contains("EXEC(") || f.Contains("RUN("))
                    return true;
            }
            catch(Exception e)
            {

            }

            return false;
        }

        // search for Excel macros and Excel4 macros
        static bool xlsContainsMacro(string filePath)
        {
            try
            {
                // Create MS Excel instance
                Microsoft.Office.Interop.Excel.Application excel = new Microsoft.Office.Interop.Excel.Application();
                // Disables macros 
                excel.Application.AutomationSecurity = MsoAutomationSecurity.msoAutomationSecurityForceDisable;
                excel.DisplayAlerts = false;

                // Open workbook
                Workbook wb = excel.Workbooks.Open(filePath, Type.Missing, true);

                // Check if there are any VBA macros
                if (wb.HasVBProject)
                {
                    return true;
                }

                ///////////////////////////////////////////////////////////////////////
                // if there are no VBA macros then we should search for Excel4 macros
                ///////////////////////////////////////////////////////////////////////

                // temp file name or saving Excel sheets
                string tempfile = Path.GetTempPath() + DateTime.Now.Ticks;

                // save each sheet as txt for faster Excel4 macro search
                int sc = wb.Sheets.Count;
                for (int s = 1; s <= sc; s++)
                {
                    Worksheet sheet = wb.Sheets[s];
                    sheet.SaveAs(tempfile + s + ".txt" , Microsoft.Office.Interop.Excel.XlFileFormat.xlTextWindows);
                }

                // Close the workbook
                wb.Close();

                // Quit MS Excel
                excel.Quit();

                // Read each sheet and search for Excel4 maros
                bool macros = false;
                for (int s = 1; s <= sc; s++)
                {
                    string f = File.ReadAllText(tempfile + s + ".txt");
                    File.Delete(tempfile + s + ".txt");
                    f = f.Replace("\t", "");

                    int formulap = f.IndexOf("FORMULA(");
                    int callp = f.IndexOf("CALL(");
                    int execp = f.IndexOf("EXEC(");
                    int runp = f.IndexOf("RUN(");

                    if(formulap>-1 || callp > -1 || execp>-1 || runp > -1)
                    {
                        macros = true;
                    }
                    
                    //TODO: print suspicious Excel4 macros contents

                }

                if (macros)
                    return true;


            }
            catch (Exception ex)
            {
                throw ex;
            }

            return false;
        }

    }
}
